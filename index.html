<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FlashDeck — Cold UI Flashcards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <style>
    /* ---------- Cold UI Theme & Layout ---------- */
    :root {
      --bg0: #060710;
      --bg1: #0a0c18;
      --panel: rgba(12, 16, 32, 0.62);
      --panel2: rgba(12, 16, 32, 0.34);
      --stroke2: rgba(255,255,255,0.08);
      --text: #e9f1ff;
      --muted: rgba(233, 241, 255, 0.72);
      --lime: #7CFFB2;
      --danger: #ff4d7d;
      --radius: 20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{
      box-sizing: border-box;
    }
    html,body{
      height:100%;
      margin:0;
      padding:0;
    }
    body {
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(167,75,255,0.16), transparent 60%),
        radial-gradient(1000px 700px at 80% 25%, rgba(51,214,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    .container {
      max-width: 1180px;
      margin: 25px auto 0 auto;
      padding: 16px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
    }
    header.panel {
      border-radius: 14px;
      padding: 12px 14px;
      background: var(--panel2);
      border: 1px solid var(--stroke2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .logo {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgb(51,214,255,.9), rgb(167,75,255,.88));
      box-shadow: 0 8px 28px rgba(51,214,255,.12);
    }
    .brand .title {
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight: bold;
    }
    .hdr-controls {
      display: flex;
      gap:10px;
      align-items: center;
    }
    .tiny {
      font-size:12px;
      color:var(--muted);
      font-family:var(--mono);
    }
    main {
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width:980px) {
      main {grid-template-columns: 1fr;}
    }
    .panel {
      border-radius: 14px;
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
    }
    label {
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
      margin:8px 0 6px;
      display:block;
      text-transform:uppercase;
      letter-spacing:.02em;
    }
    input[type="text"], textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font:inherit;
      resize:vertical;
    }
    textarea {min-height:60px;}
    .btnbar {
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    button {
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      font-size: 14px;
      transition: background 0.1s, border 0.1s;
    }
    button.primary {
      background: linear-gradient(135deg, rgba(51,214,255,.18), rgba(167,75,255,.15));
      border-color: rgba(51,214,255,.12);
    }
    button.danger {
      background: rgba(255,77,125,.06);
      border-color: rgba(255,77,125,.14);
    }
    button:disabled {
      opacity:0.55;
      pointer-events:none;
    }
    .card-list {
      margin-top:10px;
      display:grid;
      gap:10px;
      max-height:320px;
      overflow:auto;
      padding-right:6px;
    }
    .list-item {
      padding:10px;
      border-radius:10px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.04);
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .list-item p {margin:0;}
    .list-item .q {font-weight:600; color:var(--text);}
    .list-item .a {color:var(--muted); font-size:13px; margin-top:6px;}
    .study {
      padding:12px;
      display:grid;
      gap:12px;
    }
    .study-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .deckname h2 {
      margin:0;
      font-size:17px;
      font-weight: 700;
    }
    .deckname p {
      margin:0;
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
    }
    .progress {
      display:flex;
      align-items:center;
      gap:10px;
      font-family:var(--mono);
      color:var(--muted);
    }
    .bar {
      width:150px;
      height:10px;
      border-radius:999px;
      background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.04);
      overflow:hidden;
    }
    .bar > i {
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(51,214,255,.7), rgba(167,75,255,.7));
    }
    .card-stage {
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:340px;
    }
    .card3d {
      width:100%;
      max-width:520px;
      min-height:380px;
      perspective:1400px;
    }
    .card {
      width:100%;
      min-height:320px;
      border-radius:18px;
      position:relative;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
      transition: transform 560ms cubic-bezier(.2,.9,.2,1);
      cursor:pointer;
      outline:none;
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 32px rgba(0,0,0,.38);
      will-change:transform;
      overflow:hidden;
    }
    .card.flipped { transform: rotateY(180deg); }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:20px;
      pointer-events:none;
      z-index: 0;
      background:
        radial-gradient(360px 180px at 30% 10%, rgba(51,214,255,.08), transparent 60%),
        radial-gradient(360px 110px at 80% 15%, rgba(167,75,255,.10), transparent 60%);
      transform: translateZ(-1px);
    }
    .face {
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:24px;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      box-sizing:border-box;
      width:100%;
      height:100%;
      z-index:2;
      color:var(--text);
      background:rgba(24,32,54,0.82);
    }
    .face.front {
      background: linear-gradient(135deg, rgba(28,36,56,.97), rgba(45,28,54,.93));
      z-index:2;
      transform: rotateY(0deg);
    }
    .face.back {
      background: linear-gradient(135deg, rgba(42,18,54,.94), rgba(40,60,80,.93));
      color: var(--lime);
      z-index:2;
      transform: rotateY(180deg);
    }
    .face .meta {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
    }
    .content {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:6px;
      flex:1;
    }
    .content .big {
      font-size: clamp(18px, 2.6vw, 34px);
      line-height:1.12;
      margin:0;
      word-break:break-word;
    }
    .content .small {
      font-size:16px;
      color:var(--muted);
    }
    .controls {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    footer {
      margin-top:18px;
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }
    .toast {
      position:fixed;
      left:50%;
      bottom:20px;
      transform: translateX(-50%) translateY(10px);
      background: rgba(0,0,0,.54);
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.09);
      color:var(--text);
      opacity:0;
      pointer-events:none;
      transition:opacity .16s, transform .22s;
      font-family:var(--mono);
    }
    .toast.show {
      opacity:1;
      transform: translateX(-50%) translateY(0);
      pointer-events:auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Bar -->
    <header class="panel">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">FlashDeck</div>
          <div class="tiny">Cold UI — local storage, single file</div>
        </div>
      </div>
      <div class="hdr-controls">
        <div class="tiny">Space: flip · ←/→: nav · S: shuffle · K: known</div>
      </div>
    </header>
    <!-- Main Area -->
    <main>
      <!-- Deck builder -->
      <section class="panel" aria-label="Deck builder">
        <div>
          <label for="deckName">Deck name</label>
          <input id="deckName" type="text" placeholder="e.g., Spanish Verbs" />
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <div>
              <label for="question">Front (term / question)</label>
              <textarea id="question" placeholder="e.g., ¿Cómo se dice 'cat' en español?"></textarea>
            </div>
            <div>
              <label for="answer">Back (answer / definition)</label>
              <textarea id="answer" placeholder="e.g., Gato"></textarea>
            </div>
          </div>
          <div class="btnbar">
            <button class="primary" id="addCardBtn">Add card</button>
            <button id="newDeckBtn">New deck</button>
            <button id="saveDeckBtn">Save deck</button>
            <button id="exportBtn">Export JSON</button>
            <button id="importBtn">Import JSON</button>
            <input id="importFile" type="file" accept="application/json" hidden />
            <button class="danger" id="clearAllBtn" title="Deletes all decks stored in this browser">Clear all</button>
          </div>
          <div class="card-list" id="cardList" aria-label="Card list"></div>
        </div>
      </section>
      <!-- Study / flashcard -->
      <section class="panel study" aria-label="Study">
        <div class="study-head">
          <div class="deckname">
            <h2 id="studyDeckTitle">No deck loaded</h2>
            <p id="studyMeta">Create or load a deck to begin studying.</p>
          </div>
          <div class="progress">
            <div id="posText">0 / 0</div>
            <div class="bar" aria-hidden="true"><i id="barFill"></i></div>
          </div>
        </div>
        <div class="card-stage">
          <div class="card3d">
            <div id="flashcard" class="card" tabindex="0" role="button" aria-label="Flashcard (click to flip)">
              <div class="face front">
                <div class="meta"><div>FRONT</div><div id="cardIdText">—</div></div>
                <div class="content"><p class="big" id="frontText">Create a deck and add a card.</p></div>
                <div class="meta"><div class="tiny">Space / Click to flip</div><div id="timeText">ready</div></div>
              </div>
              <div class="face back">
                <div class="meta"><div>BACK</div><div id="backTag" class="tiny">definition</div></div>
                <div class="content"><p class="small" id="backText">Your answer will appear here.</p></div>
                <div class="meta"><div class="tiny">← / → to navigate</div><div id="cardState" class="tiny">state</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="controls" style="justify-content:space-between;">
          <div class="btnbar">
            <button id="prevBtn">Prev</button>
            <button class="primary" id="flipBtn">Flip</button>
            <button id="nextBtn">Next</button>
            <button id="shuffleBtn">Shuffle</button>
            <button id="resetOrderBtn" title="Restore original order">Reset</button>
          </div>
          <div class="btnbar">
            <button id="markKnownBtn">Known</button>
            <button id="markReviewBtn">Review</button>
            <button class="danger" id="deleteCurrentBtn">Delete</button>
          </div>
        </div>
      </section>
    </main>
    <!-- Footer -->
    <footer>
      <div>Keys: <strong>Space</strong> flip · <strong>←</strong>/<strong>→</strong> nav · <strong>S</strong> shuffle</div>
      <div class="tiny">All data stored locally (localStorage)</div>
    </footer>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
    // ---------- DATA / STORAGE ----------
    const STORAGE_KEY = "flashdeck.v1";
    const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

    let db = { decks: [] };
    const state = { deckId: null, order: [], index: 0, flipped: false, lastFlipAt: performance.now() };

    function loadDB(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) db = JSON.parse(raw) || { decks: [] };
      }catch(e){ db = { decks: [] }; }
    }
    function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    function getDeck(){ return db.decks.find(d => d.id === state.deckId) || null; }
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove("show"), 1400);
    }
    // ---------- UI refs ----------
    const $ = id => document.getElementById(id);
    const deckName = $("deckName"), question = $("question"), answer = $("answer");
    const addCardBtn = $("addCardBtn"), newDeckBtn = $("newDeckBtn"), saveDeckBtn = $("saveDeckBtn");
    const exportBtn = $("exportBtn"), importBtn = $("importBtn"), importFile = $("importFile");
    const clearAllBtn = $("clearAllBtn");
    const cardList = $("cardList");
    const studyDeckTitle = $("studyDeckTitle"), studyMeta = $("studyMeta"), posText = $("posText"), barFill = $("barFill");
    const flashcard = $("flashcard"), frontText = $("frontText"), backText = $("backText"), cardIdText = $("cardIdText"), timeText = $("timeText"), cardState = $("cardState");
    const prevBtn = $("prevBtn"), nextBtn = $("nextBtn"), flipBtn = $("flipBtn"), shuffleBtn = $("shuffleBtn"), resetOrderBtn = $("resetOrderBtn");
    const markKnownBtn = $("markKnownBtn"), markReviewBtn = $("markReviewBtn"), deleteCurrentBtn = $("deleteCurrentBtn");

    // ---------- Rendering ----------
    function ensureOrder(){
      const deck = getDeck();
      if(!deck){ state.order = []; state.index = 0; return; }
      const ids = deck.cards.map(c => c.id);
      const kept = state.order.filter(id => ids.includes(id));
      const missing = ids.filter(id => !kept.includes(id));
      state.order = kept.concat(missing);
      if(state.index < 0) state.index = 0;
      if(state.index > state.order.length-1) state.index = Math.max(0, state.order.length-1);
    }
    function getCurrentCard(){
      const d = getDeck();
      if(!d) return null;
      ensureOrder();
      const id = state.order[state.index];
      return d.cards.find(c => c.id === id) || null;
    }
    function setFlipped(v){
      state.flipped = v;
      flashcard.classList.toggle("flipped", v);
      const now = performance.now();
      const elapsed = Math.max(0, Math.round((now - state.lastFlipAt)/1000));
      timeText.textContent = v ? (elapsed ? `${elapsed}s on front` : "flipped") : "front";
      state.lastFlipAt = now;
    }
    function renderStudy(){
      const d = getDeck();
      const count = d?.cards.length || 0;
      if(!d){
        studyDeckTitle.textContent = "No deck loaded";
        studyMeta.textContent = "Create a deck and add cards.";
        posText.textContent = "0 / 0";
        barFill.style.width = "0%";
        frontText.textContent = "Create a deck and add a card.";
        backText.textContent = "Your answer will appear here.";
        cardIdText.textContent = "—";
        setFlipped(false);
        disableBtns(true);
        return;
      }
      ensureOrder();
      studyDeckTitle.textContent = d.name || "Untitled deck";
      studyMeta.textContent = `${count} card${count===1?"":"s"} · stored locally`;
      const idx = count ? (state.index + 1) : 0;
      posText.textContent = `${idx} / ${count}`;
      barFill.style.width = count ? `${(idx / count) * 100}%` : "0%";
      const c = getCurrentCard();
      if(!c){
        frontText.textContent = "No cards yet. Add one on the left.";
        backText.textContent = "—";
        cardIdText.textContent = "—";
        cardState.textContent = "";
        setFlipped(false);
      }else{
        frontText.textContent = c.q || "(empty front)";
        backText.textContent = c.a || "(empty back)";
        cardIdText.textContent = c.state ? `state:${c.state}` : `id:${c.id.slice(0,6)}`;
        cardState.textContent = c.state || "none";
      }
      disableBtns(count === 0);
    }
    function disableBtns(disable){
      prevBtn.disabled = disable; nextBtn.disabled = disable; flipBtn.disabled = disable;
      shuffleBtn.disabled = disable; resetOrderBtn.disabled = disable;
      markKnownBtn.disabled = disable; markReviewBtn.disabled = disable; deleteCurrentBtn.disabled = disable;
    }
    function renderList(){
      const d = getDeck();
      cardList.innerHTML = "";
      if(!d){
        const p = document.createElement("div");
        p.className="tiny";
        p.textContent = "No deck. Click New deck and add cards.";
        cardList.appendChild(p);
        return;
      }
      if(!d.cards.length){
        const p = document.createElement("div");
        p.className="tiny";
        p.textContent = "No cards yet.";
        cardList.appendChild(p);
        return;
      }
      d.cards.slice().sort((a,b)=>a.createdAt-b.createdAt).forEach(c=>{
        const el = document.createElement("div");
        el.className="list-item";
        el.innerHTML = `<div>
          <p class="q">${escapeHTML(c.q || "(empty)")}</p>
          <p class="a">${escapeHTML(c.a || "(empty)")}</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button data-act="goto" data-id="${c.id}">Go</button>
          <button data-act="edit" data-id="${c.id}">Edit</button>
          <button data-act="del" data-id="${c.id}">Del</button>
        </div>`;
        cardList.appendChild(el);
      });
      cardList.addEventListener("click", onListClick, { once:true });
    }
    function onListClick(e){
      const btn = e.target.closest("button[data-act]");
      if(!btn){ cardList.addEventListener("click", onListClick, { once:true }); return; }
      const act = btn.getAttribute("data-act"), id = btn.getAttribute("data-id");
      const d = getDeck();
      if(!d) return;
      if(act === "del"){
        const idx = d.cards.findIndex(x=>x.id===id);
        if(idx>=0){ d.cards.splice(idx,1); saveDB(); ensureOrder(); state.index = Math.min(state.index, Math.max(0, state.order.length-1)); toast("Deleted card"); renderAll(); }
      }else if(act === "edit"){
        const c = d.cards.find(x=>x.id===id);
        if(c){ question.value = c.q; answer.value = c.a; toast("Loaded into editor"); }
      }else if(act === "goto"){
        ensureOrder();
        const ord = state.order.indexOf(id);
        if(ord>=0){ state.index = ord; setFlipped(false); toast("Jumped to card"); renderStudy(); }
      }
      cardList.addEventListener("click", onListClick, { once:true });
    }
    function escapeHTML(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }
    function renderAll(){ renderList(); renderStudy(); }
    // ---------- Actions ----------
    function newDeck(){
      const d = { id: uid(), name: deckName.value.trim() || "Untitled deck", createdAt: Date.now(), cards: [] };
      db.decks.push(d); state.deckId = d.id; state.order = []; state.index = 0; saveDB(); toast("New deck created"); renderAll();
    }
    function ensureDeckExists(){
      const cur = getDeck();
      if(cur) return cur;
      const d = { id: uid(), name: deckName.value.trim() || "Untitled deck", createdAt: Date.now(), cards: [] };
      db.decks.push(d); state.deckId = d.id; state.order = []; state.index = 0; saveDB(); toast("Deck created"); return d;
    }
    function addCard(){
      const d = ensureDeckExists();
      const q = question.value.trim(), a = answer.value.trim();
      if(!q && !a){ toast("Enter front or back"); return; }
      const c = { id: uid(), q, a, createdAt: Date.now(), state: "" };
      d.cards.push(c); question.value=""; answer.value=""; question.focus();
      saveDB(); ensureOrder();
      state.index = state.order.indexOf(c.id);
      setFlipped(false); toast("Added card"); renderAll();
    }
    function saveDeckName(){
      const d = getDeck();
      if(!d){ toast("No deck to save"); return; }
      d.name = deckName.value.trim() || "Untitled deck";
      saveDB(); toast("Saved"); renderAll();
    }
    function prev(){
      const d=getDeck(); if(!d||d.cards.length<=1) return;
      ensureOrder();
      state.index=(state.index-1+state.order.length)%state.order.length;
      setFlipped(false); renderStudy();
    }
    function next(){
      const d=getDeck(); if(!d||d.cards.length<=1) return;
      ensureOrder();
      state.index=(state.index+1)%state.order.length;
      setFlipped(false); renderStudy();
    }
    function flip(){
      const d=getDeck();
      if(!d||d.cards.length===0) return;
      setFlipped(!state.flipped);
    }
    function shuffle(){
      const d=getDeck(); if(!d||d.cards.length<=1) return;
      ensureOrder();
      for(let i=state.order.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [state.order[i],state.order[j]]=[state.order[j],state.order[i]];
      }
      state.index=0; setFlipped(false); toast("Shuffled"); renderStudy();
    }
    function resetOrder(){
      const d=getDeck(); if(!d||d.cards.length<=1) return;
      state.order = d.cards.slice().sort((a,b)=>a.createdAt-b.createdAt).map(c=>c.id);
      state.index = 0; setFlipped(false); toast("Order reset"); renderStudy();
    }
    function mark(stateName){
      const c = getCurrentCard(), d = getDeck(); if(!c||!d) return;
      c.state = stateName; saveDB(); toast(`Marked ${stateName}`); renderAll();
    }
    function deleteCurrent(){
      const d = getDeck(), c = getCurrentCard(); if(!d||!c) return;
      const idx = d.cards.findIndex(x=>x.id===c.id);
      if(idx>=0){
        d.cards.splice(idx,1); saveDB(); ensureOrder();
        state.index = Math.min(state.index, Math.max(0, state.order.length-1));
        setFlipped(false); toast("Deleted card"); renderAll();
      }
    }
    function exportJSON(){
      const payload = { exportedAt: new Date().toISOString(), app:"flashdeck", version:1, db };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download=`flashdeck-export-${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast("Exported JSON");
    }
    function importJSONFile(file){
      const r = new FileReader();
      r.onload = () => {
        try{
          const data = JSON.parse(String(r.result || "{}"));
          const imported = data.db?.decks ? data.db : data;
          if(!imported || !Array.isArray(imported.decks)) throw new Error("Invalid format");
          const byId = new Map(db.decks.map(d=>[d.id,d]));
          for(const d of imported.decks){ if(!d?.id) continue; byId.set(d.id,d); }
          db.decks = Array.from(byId.values()).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
          const last = db.decks[db.decks.length-1] || null;
          state.deckId = last ? last.id : null; state.order = []; state.index = 0; saveDB(); toast("Imported"); if(last) deckName.value = last.name || "Untitled deck"; renderAll();
        }catch(err){ console.error(err); toast("Import failed"); }
      };
      r.readAsText(file);
    }
    function clearAll(){
      if(!confirm("Delete ALL decks stored in this browser?")) return;
      db = { decks: [] }; state.deckId = null; state.order = []; state.index = 0; localStorage.removeItem(STORAGE_KEY); toast("Cleared"); renderAll();
    }

    // ---------- Initialization ----------
    loadDB();
    if(db.decks.length){
      db.decks.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
      const last = db.decks[db.decks.length-1];
      state.deckId = last.id; deckName.value = last.name || "Untitled deck";
      state.order = last.cards.slice().sort((a,b)=>a.createdAt-b.createdAt).map(c => c.id);
    }
    renderAll();

    // ---------- Events ----------
    addCardBtn.addEventListener("click", addCard);
    newDeckBtn.addEventListener("click", newDeck);
    saveDeckBtn.addEventListener("click", saveDeckName);
    exportBtn.addEventListener("click", exportJSON);
    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", () => {
      const f = importFile.files && importFile.files[0];
      if(f) importJSONFile(f);
      importFile.value = "";
    });
    clearAllBtn.addEventListener("click", clearAll);

    prevBtn.addEventListener("click", prev);
    nextBtn.addEventListener("click", next);
    flipBtn.addEventListener("click", flip);
    shuffleBtn.addEventListener("click", shuffle);
    resetOrderBtn.addEventListener("click", resetOrder);
    markKnownBtn.addEventListener("click", ()=>mark("known"));
    markReviewBtn.addEventListener("click", ()=>mark("review"));
    deleteCurrentBtn.addEventListener("click", deleteCurrent);

    // Click / keyboard for flip
    flashcard.addEventListener("click", (e)=>{
      if(e.target.closest("button")) return;
      flip();
    });

    // Keyboard controls (avoid while typing)
    window.addEventListener("keydown", (e)=>{
      const t = e.target;
      const typing = t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.isContentEditable);
      if(typing){
        if((e.ctrlKey||e.metaKey) && e.key === "Enter"){ e.preventDefault(); addCard(); }
        return;
      }
      if(e.key === "ArrowLeft"){ e.preventDefault(); prev(); }
      else if(e.key === "ArrowRight"){ e.preventDefault(); next(); }
      else if(e.key === " "){ e.preventDefault(); flip(); }
      else if(e.key.toLowerCase() === "s"){ shuffle(); }
      else if(e.key.toLowerCase() === "k"){ mark("known"); }
      else if(e.key.toLowerCase() === "r"){ mark("review"); }
      else if(e.key === "Delete" || e.key === "Backspace"){ if(e.shiftKey) deleteCurrent(); }
    });

    // Focus/space to flip accessibility
    flashcard.addEventListener("keyup", (e)=>{ if(e.key === " "){ flip(); } });

    // Listen for localStorage changes
    window.addEventListener("storage", (e)=>{ if(e.key === STORAGE_KEY) { loadDB(); renderAll(); } });
  </script>
</body>
</html>
